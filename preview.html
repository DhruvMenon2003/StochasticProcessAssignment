<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stochastic Process Analyzer - Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;
        const { createPortal } = ReactDOM;

        // Lucide Icons
        const Upload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const Calculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="16" y1="18" x2="16" y2="18.01"/><line x1="12" y1="18" x2="12" y2="18.01"/><line x1="8" y1="18" x2="8" y2="18.01"/></svg>;
        const PlayCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>;
        const CheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const TrendingUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const BarChart3 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
        const Info = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const Save = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const FolderOpen = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;

        // Mock CSV Parser
        const parseCsvData = (csvString) => {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return { headers: [], rows: [] };
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1).map(line => {
                return line.split(',').map(cell => {
                    const trimmedCell = cell.trim();
                    return isNaN(Number(trimmedCell)) || trimmedCell === '' ? trimmedCell : Number(trimmedCell);
                });
            });
            return { headers, rows };
        };

        const analyzeCsvStructure = (data) => {
            if (data.headers.length === 0) return [];
            const infos = data.headers.map(h => ({ name: h, type: 'numerical' }));
            const uniqueStates = {};
            data.headers.forEach(h => { uniqueStates[h] = new Set(); });

            data.rows.forEach(row => {
                data.headers.forEach((h, index) => {
                    const value = row[index];
                    if (value !== undefined && value !== '') {
                        uniqueStates[h].add(value);
                        if (typeof value === 'string' && isNaN(Number(value))) {
                            infos[index].type = 'nominal';
                        }
                    }
                });
            });

            return infos.map(info => ({
                ...info,
                states: Array.from(uniqueStates[info.name]).sort().join(', '),
            }));
        };

        // Simple Variable Type Modal
        const VariableTypeModal = ({ isOpen, initialVariables, onConfirm, onCancel }) => {
            const [variables, setVariables] = useState([]);

            useEffect(() => {
                setVariables(JSON.parse(JSON.stringify(initialVariables)));
            }, [initialVariables]);

            const handleTypeChange = (index, newType) => {
                setVariables(prev => {
                    const newVars = [...prev];
                    newVars[index].type = newType;
                    return newVars;
                });
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 border border-gray-600 rounded-lg shadow-xl w-full max-w-2xl">
                        <div className="p-6">
                            <h2 className="text-2xl font-bold text-gray-100 mb-2">Define Variable Types</h2>
                            <p className="text-gray-400 mb-6">
                                Please confirm or correct their types to ensure accurate analysis.
                            </p>
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                {variables.map((variable, index) => (
                                    <div key={variable.name} className="grid grid-cols-5 gap-4 items-center bg-gray-900/50 p-3 rounded-md border border-gray-700">
                                        <div className="col-span-2">
                                            <label className="block text-xs font-medium text-gray-400 mb-1">Variable Name</label>
                                            <input
                                                type="text"
                                                value={variable.name}
                                                readOnly
                                                className="w-full p-2 bg-gray-700/50 text-gray-400 border border-gray-600 rounded-md text-sm"
                                            />
                                        </div>
                                        <div className="col-span-3">
                                            <label className="block text-xs font-medium text-gray-400 mb-1">Variable Type</label>
                                            <select
                                                value={variable.type}
                                                onChange={(e) => handleTypeChange(index, e.target.value)}
                                                className="w-full p-2 bg-gray-800 text-gray-300 border border-gray-600 rounded-md text-sm"
                                            >
                                                <option value="numerical">Numerical</option>
                                                <option value="nominal">Categorical (Nominal)</option>
                                                <option value="ordinal">Categorical (Ordinal)</option>
                                            </select>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="bg-gray-900/50 px-6 py-4 rounded-b-lg flex justify-end gap-4">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700">Cancel</button>
                            <button onClick={() => onConfirm(variables)} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Confirm Variable Types</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SESSIONS_KEY = 'stochasticAnalyzerSessions';
        const AUTOSAVE_KEY = 'stochasticAnalyzerAutosave';

        const StochasticAnalyzer = () => {
            const [activeStep, setActiveStep] = useState(1);
            const [csvData, setCsvData] = useState('');
            const [parsedData, setParsedData] = useState({ headers: [], rows: [] });
            const [variableInfo, setVariableInfo] = useState([]);
            const [models, setModels] = useState([]);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);

            const [savedSessions, setSavedSessions] = useState({});
            const [sessionMenuOpen, setSessionMenuOpen] = useState(false);
            const [newSessionName, setNewSessionName] = useState('');
            const sessionMenuRef = useRef(null);
            const sessionButtonRef = useRef(null);
            const [dropdownPosition, setDropdownPosition] = useState({ top: 0, right: 0 });

            const [isTypeModalOpen, setIsTypeModalOpen] = useState(false);
            const [pendingVariableInfo, setPendingVariableInfo] = useState([]);

            const exampleData = `VarX,VarY
A,1
B,2
A,1
A,2
B,1
C,2
A,1
B,2
C,1`;

            const steps = [
                { num: 1, title: 'Upload Data', icon: Upload },
                { num: 2, title: 'Define Models', icon: Calculator },
                { num: 3, title: 'Run Analysis', icon: PlayCircle },
            ];

            useEffect(() => {
                const sessionsJSON = localStorage.getItem(SESSIONS_KEY);
                if (sessionsJSON) {
                    try { setSavedSessions(JSON.parse(sessionsJSON)); } catch (e) {}
                }
                const autosaveJSON = localStorage.getItem(AUTOSAVE_KEY);
                if (autosaveJSON) {
                    try {
                        const autosave = JSON.parse(autosaveJSON);
                        setCsvData(autosave.csvData || '');
                        setVariableInfo(autosave.variableInfo || []);
                        setModels(autosave.models || []);
                        if (autosave.csvData) setParsedData(parseCsvData(autosave.csvData));
                    } catch (e) {}
                }
            }, []);

            useEffect(() => {
                if (csvData || variableInfo.length > 0 || models.length > 0) {
                    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ csvData, variableInfo, models, timestamp: Date.now() }));
                }
            }, [csvData, variableInfo, models]);

            const updateDropdownPosition = useCallback(() => {
                if (sessionButtonRef.current) {
                    const rect = sessionButtonRef.current.getBoundingClientRect();
                    setDropdownPosition({ top: rect.bottom + 8, right: window.innerWidth - rect.right });
                }
            }, []);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (sessionMenuRef.current && !sessionMenuRef.current.contains(event.target) &&
                        sessionButtonRef.current && !sessionButtonRef.current.contains(event.target)) {
                        setSessionMenuOpen(false);
                    }
                };
                if (sessionMenuOpen) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [sessionMenuOpen]);

            const handleDataSubmit = useCallback(() => {
                if (!csvData.trim()) return;
                const parsed = parseCsvData(csvData);
                setParsedData(parsed);
                const detectedVariables = analyzeCsvStructure(parsed);
                setPendingVariableInfo(detectedVariables);
                setIsTypeModalOpen(true);
            }, [csvData]);

            const handleTypeConfirmation = useCallback((confirmedVariables) => {
                setVariableInfo(confirmedVariables);
                setIsTypeModalOpen(false);
                setActiveStep(2);
                const defaultModel = {
                    id: 'uniform-' + Date.now(),
                    name: 'Uniform Distribution',
                    variables: confirmedVariables,
                    probabilities: {},
                    error: null,
                    modelString: '',
                };
                setModels([defaultModel]);
            }, []);

            const handleCancelTypeConfirmation = useCallback(() => {
                setIsTypeModalOpen(false);
                setPendingVariableInfo([]);
            }, []);

            const handleAnalyze = () => {
                setAnalyzing(true);
                setTimeout(() => {
                    setAnalyzing(false);
                    setResults({ bestModel: 'Uniform Distribution', hellinger: 0.0234, accuracy: 94.2, variables: variableInfo.map(v => v.name) });
                    setActiveStep(3);
                }, 2000);
            };

            const handleSaveSession = useCallback(() => {
                if (!newSessionName.trim()) { alert('Please enter a session name'); return; }
                const session = { csvData, variableInfo, models, timestamp: Date.now() };
                const updated = { ...savedSessions, [newSessionName]: session };
                setSavedSessions(updated);
                localStorage.setItem(SESSIONS_KEY, JSON.stringify(updated));
                setNewSessionName('');
                alert(`Session "${newSessionName}" saved successfully!`);
            }, [newSessionName, csvData, variableInfo, models, savedSessions]);

            const handleLoadSession = useCallback((name) => {
                const session = savedSessions[name];
                if (session) {
                    setCsvData(session.csvData);
                    setVariableInfo(session.variableInfo);
                    setModels(session.models);
                    setParsedData(parseCsvData(session.csvData));
                    setActiveStep(session.variableInfo.length > 0 ? 2 : 1);
                    alert(`Session "${name}" loaded successfully!`);
                }
            }, [savedSessions]);

            const handleDeleteSession = useCallback((name) => {
                if (confirm(`Are you sure you want to delete session "${name}"?`)) {
                    const updated = { ...savedSessions };
                    delete updated[name];
                    setSavedSessions(updated);
                    localStorage.setItem(SESSIONS_KEY, JSON.stringify(updated));
                }
            }, [savedSessions]);

            const handleExportSessions = useCallback(() => {
                if (Object.keys(savedSessions).length === 0) { alert('No sessions to export'); return; }
                const dataStr = JSON.stringify(savedSessions, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'stochastic_sessions.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, [savedSessions]);

            const handleImportSessions = useCallback((event) => {
                const file = event.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target?.result;
                        const imported = JSON.parse(text);
                        if (typeof imported !== 'object') throw new Error('Invalid format');
                        const merged = { ...savedSessions, ...imported };
                        setSavedSessions(merged);
                        localStorage.setItem(SESSIONS_KEY, JSON.stringify(merged));
                        alert(`Successfully imported ${Object.keys(imported).length} session(s)!`);
                    } catch (error) {
                        alert('Failed to import sessions. Please check the file format.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }, [savedSessions]);

            const handleClearAll = useCallback(() => {
                if (confirm('Are you sure you want to clear all data and sessions?')) {
                    setCsvData('');
                    setVariableInfo([]);
                    setModels([]);
                    setParsedData({ headers: [], rows: [] });
                    setResults(null);
                    setActiveStep(1);
                    localStorage.removeItem(AUTOSAVE_KEY);
                }
            }, []);

            const toggleSessionMenu = useCallback(() => {
                if (!sessionMenuOpen) updateDropdownPosition();
                setSessionMenuOpen(!sessionMenuOpen);
            }, [sessionMenuOpen, updateDropdownPosition]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    <VariableTypeModal
                        isOpen={isTypeModalOpen}
                        initialVariables={pendingVariableInfo}
                        onConfirm={handleTypeConfirmation}
                        onCancel={handleCancelTypeConfirmation}
                    />

                    <div className="bg-slate-900/50 backdrop-blur-sm border-b border-slate-700/50 relative z-50">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center">
                                        <TrendingUp />
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold text-white">Stochastic Process Analyzer</h1>
                                        <p className="text-sm text-slate-400">Statistical Analysis & Model Comparison</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setCsvData(exampleData)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg text-sm font-medium transition-all border border-slate-600">
                                        Load Example
                                    </button>
                                    <button ref={sessionButtonRef} onClick={toggleSessionMenu} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-lg text-sm font-medium transition-all border border-slate-600 flex items-center gap-2">
                                        <FolderOpen />
                                        Sessions
                                    </button>
                                    <button onClick={handleClearAll} className="px-4 py-2 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded-lg text-sm font-medium transition-all border border-red-700/50 flex items-center gap-2">
                                        <Trash2 />
                                        Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="flex items-center justify-between mb-12">
                            {steps.map((step, idx) => (
                                <React.Fragment key={step.num}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${activeStep >= step.num ? 'bg-gradient-to-br from-blue-500 to-cyan-500 shadow-lg shadow-blue-500/30' : 'bg-slate-800 border-2 border-slate-600'}`}>
                                            {activeStep > step.num ? <CheckCircle /> : <step.icon />}
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500 font-medium">Step {step.num}</p>
                                            <p className={`text-sm font-semibold ${activeStep >= step.num ? 'text-white' : 'text-slate-400'}`}>{step.title}</p>
                                        </div>
                                    </div>
                                    {idx < steps.length - 1 && <div className={`flex-1 h-0.5 mx-4 transition-all ${activeStep > step.num ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-slate-700'}`} />}
                                </React.Fragment>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6 shadow-xl">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-2">
                                            <Upload />
                                            <h3 className="text-lg font-bold text-white">Input Data</h3>
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-slate-400">
                                            <Info />
                                            <span>CSV format with headers</span>
                                        </div>
                                    </div>
                                    <textarea
                                        value={csvData}
                                        onChange={(e) => setCsvData(e.target.value)}
                                        placeholder="Paste CSV data here..."
                                        className="w-full h-64 bg-slate-900/50 text-slate-200 border border-slate-600 rounded-lg p-4 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <div className="mt-4 flex items-center justify-between">
                                        <p className="text-sm text-slate-400">{csvData.split('\n').filter(l => l.trim()).length - 1} rows detected</p>
                                        <button onClick={handleDataSubmit} disabled={!csvData.trim()} className="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 disabled:from-slate-600 disabled:to-slate-600 text-white rounded-lg font-medium transition-all shadow-lg disabled:shadow-none">
                                            Continue
                                        </button>
                                    </div>
                                </div>

                                {variableInfo.length > 0 && (
                                    <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6 shadow-xl">
                                        <h3 className="text-lg font-bold text-white mb-4">Detected Variables</h3>
                                        <div className="space-y-2">
                                            {variableInfo.map((variable) => (
                                                <div key={variable.name} className="bg-slate-900/50 rounded-lg p-3 border border-slate-600">
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-medium text-white">{variable.name}</span>
                                                        <span className="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded-full">{variable.type}</span>
                                                    </div>
                                                    <div className="text-sm text-slate-400 mt-1">States: {variable.states}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {activeStep >= 2 && (
                                    <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6 shadow-xl">
                                        <div className="flex items-center gap-2 mb-4">
                                            <Calculator />
                                            <h3 className="text-lg font-bold text-white">Theoretical Models</h3>
                                            <span className="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded-full">Optional</span>
                                        </div>
                                        <div className="space-y-3">
                                            {models.map((model) => (
                                                <div key={model.id} className="bg-slate-900/50 rounded-lg p-4 border border-slate-600">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <span className="font-medium text-white">{model.name}</span>
                                                        <span className="text-xs text-slate-400">{model.variables.length} variable{model.variables.length !== 1 ? 's' : ''}</span>
                                                    </div>
                                                    <div className="text-sm text-slate-400">Variables: {model.variables.map(v => `${v.name} (${v.type})`).join(', ')}</div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="mt-4 flex justify-end">
                                            <button onClick={handleAnalyze} className="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded-lg font-medium transition-all shadow-lg">
                                                Run Analysis
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-blue-900/20 to-cyan-900/20 backdrop-blur-sm rounded-xl border border-blue-500/30 p-6 shadow-xl">
                                    <div className="flex items-center gap-2 mb-4">
                                        <BarChart3 />
                                        <h3 className="text-lg font-bold text-white">Analysis Type</h3>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="bg-slate-900/50 rounded-lg p-3">
                                            <p className="text-sm font-medium text-slate-300 mb-1">Cross-Sectional</p>
                                            <p className="text-xs text-slate-400">Independent observations</p>
                                        </div>
                                        <div className="text-xs text-slate-500 leading-relaxed">Each row treated as independent sample. Analyzes joint distributions and marginals.</div>
                                    </div>
                                </div>

                                <div className="bg-slate-800/30 backdrop-blur-sm rounded-xl border border-slate-700/30 p-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Save />
                                        <p className="text-xs font-semibold text-slate-400">Auto-save Active</p>
                                    </div>
                                    <p className="text-xs text-slate-500">Your work is automatically saved to browser storage</p>
                                </div>

                                {analyzing && (
                                    <div className="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 p-6 shadow-xl animate-pulse">
                                        <div className="flex items-center gap-2 mb-4">
                                            <div className="w-5 h-5 border-2 border-blue-400 border-t-transparent rounded-full animate-spin" />
                                            <h3 className="text-lg font-bold text-white">Analyzing...</h3>
                                        </div>
                                        <div className="space-y-2">
                                            {[1,2,3].map(i => <div key={i} className="h-3 bg-slate-700 rounded animate-pulse" style={{width: `${60 + i*15}%`}} />)}
                                        </div>
                                    </div>
                                )}

                                {results && !analyzing && (
                                    <div className="bg-gradient-to-br from-green-900/20 to-emerald-900/20 backdrop-blur-sm rounded-xl border border-green-500/30 p-6 shadow-xl">
                                        <div className="flex items-center gap-2 mb-4">
                                            <CheckCircle />
                                            <h3 className="text-lg font-bold text-white">Results</h3>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <p className="text-xs text-slate-400 mb-1">Best Model</p>
                                                <p className="text-lg font-bold text-white">{results.bestModel}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-slate-900/50 rounded-lg p-3">
                                                    <p className="text-xs text-slate-400 mb-1">Hellinger Dist.</p>
                                                    <p className="text-xl font-bold text-cyan-400">{results.hellinger}</p>
                                                </div>
                                                <div className="bg-slate-900/50 rounded-lg p-3">
                                                    <p className="text-xs text-slate-400 mb-1">Fit Quality</p>
                                                    <p className="text-xl font-bold text-green-400">{results.accuracy}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-800/30 backdrop-blur-sm rounded-xl border border-slate-700/30 p-4">
                                    <p className="text-xs font-semibold text-slate-400 mb-2">Quick Tips</p>
                                    <ul className="text-xs text-slate-500 space-y-1.5">
                                        <li>• Use comma-separated CSV format</li>
                                        <li>• Include headers in first row</li>
                                        <li>• Choose variable types when prompted</li>
                                        <li>• Save sessions for later use</li>
                                        <li>• Export/import sessions as JSON files</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    {sessionMenuOpen && createPortal(
                        <div ref={sessionMenuRef} className="fixed w-80 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-[99999]" style={{ top: `${dropdownPosition.top}px`, right: `${dropdownPosition.right}px` }}>
                            <div className="p-4 space-y-3">
                                <div>
                                    <label className="text-sm font-semibold text-slate-300 block mb-2">Save Current Session</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={newSessionName} onChange={(e) => setNewSessionName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSaveSession()} placeholder="Enter session name..." className="flex-1 px-3 py-2 bg-slate-900 text-slate-200 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                                        <button onClick={handleSaveSession} disabled={!newSessionName.trim()} className="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg transition-all">
                                            <Save />
                                        </button>
                                    </div>
                                </div>
                                {Object.keys(savedSessions).length > 0 && (
                                    <>
                                        <hr className="border-slate-600" />
                                        <div className="max-h-60 overflow-y-auto space-y-2">
                                            <h4 className="text-sm font-semibold text-slate-300">Saved Sessions</h4>
                                            {Object.keys(savedSessions).map(name => (
                                                <div key={name} className="flex items-center justify-between bg-slate-900/50 p-2 rounded-lg">
                                                    <span className="text-sm text-slate-300 truncate flex-1">{name}</span>
                                                    <div className="flex items-center gap-1">
                                                        <button onClick={() => handleLoadSession(name)} className="p-1.5 text-slate-400 hover:text-green-400 transition-colors" title="Load Session"><FolderOpen /></button>
                                                        <button onClick={() => handleDeleteSession(name)} className="p-1.5 text-slate-400 hover:text-red-400 transition-colors" title="Delete Session"><Trash2 /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                                <hr className="border-slate-600" />
                                <div className="flex gap-2">
                                    <label className="flex-1 cursor-pointer">
                                        <input type="file" accept=".json" onChange={handleImportSessions} className="hidden" />
                                        <div className="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-sm text-center transition-all flex items-center justify-center gap-2">
                                            <Upload />
                                            Import
                                        </div>
                                    </label>
                                    <button onClick={handleExportSessions} className="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-sm transition-all flex items-center justify-center gap-2">
                                        <Download />
                                        Export
                                    </button>
                                </div>
                            </div>
                        </div>,
                        document.body
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StochasticAnalyzer />);
    </script>
</body>
</html>